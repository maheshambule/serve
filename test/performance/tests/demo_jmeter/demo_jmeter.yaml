~execution:
  - executor: jmeter
    concurrency: ${CONCURRENCY}
    ramp-up: ${RAMP-UP}
    hold-for: ${HOLD-FOR}
    scenario: scenario_0

~scenarios:
  scenario_0:
    requests:
    - url: http://172.31.55.180:8080/predictions/${SQZNET_NAME}
      label: ${API_LABEL}
      method: POST
      body-file: ${INPUT_IMG_PATH}

~services:
  - module: shellexec
    prepare:
      - "ssh ubuntu@172.31.55.180 nohup python serve/test/performance/agents/metrics_monitoring_server.py --start > /dev/null 2>&1 &"
      - "curl -s -O ${INPUT_IMG_URL}"
      - "ssh ubuntu@172.31.55.180 mkdir -p /tmp/ts_model_store"
      - "ssh ubuntu@172.31.55.180 ps aux | grep '${SERVER_PROCESS_NAME}' | awk '{print $2}' | xargs kill -9 2> /dev/null || true"
      - "ssh ubuntu@172.31.55.180 nohup ${SERVER_START_CMD} --model-store /tmp/ts_model_store > /dev/null 2>&1 &"
      - "sleep 20s"
      - "curl -s -X POST http://172.31.55.180:8081/models?url=${SQZNET_URL}"
      - "curl -s -X PUT  http://172.31.55.180:8081/models/${SQZNET_NAME}?min_worker=1&synchronous=true"
    post-process:
      - "ssh ubuntu@172.31.55.180 python serve/test/performance/agents/metrics_monitoring_server.py --stop"
      - "ssh ubuntu@172.31.55.180 ${SERVER_STOP_CMD} > /dev/null 2>&1"
      - "rm ${INPUT_IMG_PATH}"
      - "ssh ubuntu@172.31.55.180 rm -r /tmp/ts_model_store"
#      - "ssh ubuntu@172.31.55.180 mv logs ${ARTIFACTS_DIR}/model_server_logs"
  - module: monitoring
    server-agent:
      - address: 172.31.55.180:9009
        label: model-server
        interval: 1s
        logging: True
        metrics:
          - sum_workers_memory_rss
          - frontend_memory_rss
          - sum_workers_file_descriptors
          - frontend_file_descriptors
          - total_workers
          - total_processes


~reporting:
- module: passfail
- module: junit-xml
  data-source: pass-fail
- module: junit-xml
  data-source: sample-labels
- module: final-stats
  dump-csv : ${ARTIFACTS_DIR}/final_stats.csv
- module: passfail
  criteria:
  - class: bzt.modules.monitoring.MonitoringCriteria
    subject: model-server/sum_workers_file_descriptors
    condition: '>'
    threshold: ${TOTAL_WORKERS_FDS}
    timeframe: 1s
    fail: true
    stop: true
    diff_percent_previous : ${TOTAL_WORKERS_FDS_DIFF}

~compare_criteria:
  -